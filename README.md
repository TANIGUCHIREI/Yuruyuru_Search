# Yuruyuru_Search

公開URL: https://yuruyuru-search.com/

<img width="500" alt="スクリーンショット 2024-05-30 16 40 49" src="https://github.com/TANIGUCHIREI/Yuruyuru_Search/assets/120480219/4de921cf-955e-4fa7-8fb0-5a93213aa188">



## about me

　詳しい使い方は[こちら](https://yuruyuru-search.com/aboutsite)


wikipdiaに掲載されている小説・漫画・アニメのデータ(重複を含まず２万以上あります)から気軽に気になる作品を検索死たいと思い作成しました。

また各作品ページではその作品に類似した作品を小説・漫画・アニメ別に計３０個確認することができます。さらに友人からの希望を元に作家や声優などで再検索を行える機能を追加しました。

本来は登場人物紹介には各キャラクタの画像などを挿入したかったのですが、著作権的にアウトであることは明確であるため、代わりに他サイト(pixivやpinterestなど)で「作品名+人物名」で検索できるようなリンクを作成しました。

↓「Dr.Stone」で登場人物を表示した例

<img width="500" alt="スクリーンショット 2024-05-30 16 54 00" src="https://github.com/TANIGUCHIREI/Yuruyuru_Search/assets/120480219/883383eb-c728-482c-8f3b-d04aab6a50fd">


カテゴリを複数選択したうえで任意のワードで検索できるため、例えば「大塚明夫さんが声優やってるジョジョのキャラって誰だっけ・・・？」と思った場合は「担当：大塚明夫」を選択したあとで検索欄に「ジョジョ」と打ち込んで検索することができます。検索結果は[こちら](https://yuruyuru-search.com/results?input=%E3%82%B8%E3%83%A7%E3%82%B8%E3%83%A7&searchall=on&liData=%E6%8B%85%E5%BD%93:%E5%A4%A7%E5%A1%9A%E6%98%8E%E5%A4%AB&AndOr=OR&start_year=1900&end_year=2024&manga=on&anime=on&novel=on)。

## 動作方法

#### ⚠注意 gitignoreにも書いていますが作品のhtml情報を保管したpickleデータはgit上にアップロードしていません！（かなり大きいため）そのためローカルで動作させる場合は/データベース作成/内のc1~c3のジュピターノートブックを動作させてください。


事前にnginx,uwsgi,必要ライブラリ(pytorch,asyncioなど)をインポートしておいてください。

またnginxのconfにて80/443(SSL認証を使う場合)ポートからuwsgiを経由してFlaskにルーティングするように設定しておいてください。

カレントディレクトリをこのリポジトリに変更したうえで、
```
uwsgi --ini uwsgi.ini
```
を実行すると動作します。
## データ作成手順

1. wikipediaから各ページデータをhtmlとして取得する(あまりよろしくないが数秒ごとにスクレイピングを行った。)重複はできるだけ避けたかったので、漫画->小説->アニメの順番でスクレイピングを行った。
2. 取得したhtmlから検索に必要なデータを取得する(カテゴリや本文、talbeから作者・出版・声優・題材・ジャンルなどを取得する)
3. html本文に書かれてる「概要」・「登場人物」・「あらすじ」をそれぞれtext-embeddingし(ここではopenaiのtextebmeddingを利用した)、作成したベクトルをconcatして検索用行列を作成する。

## 工夫した点

### in 検索：
- クエリ検索だけでなく自然言語で検索してもText-Embeddingを行うことでそれなりに類似した作品を提案できるようにした。
- Wikipediaから抽出したカテゴリ情報を元に検索できるようにした。Wikipediaのカテゴリは「〜の漫画作品」のように漫画カテゴリの中でしか調べれないものが多いが、〜の部分が一致している全ての作品を提案するように変更した。
- 声優・役者で調べた場合にはその役者が担当しているキャラクターも追加で表示するようにした。またキャラクターのリンクを押すと自動的にキャラクターの詳細情報へ飛べるようにした。
- カテゴリ検索はAND,OR検索を可能にした。これにより例えば、「週間少年ジャンプ」で「吸血鬼が題材」の漫画などが簡単に調べられるようになった。（検索結果は[ここ](https://yuruyuru-search.com/results?input=&searchall=on&liData=%E9%80%B1%E5%88%8A%E5%B0%91%E5%B9%B4%E3%82%B8%E3%83%A3%E3%83%B3%E3%83%97,%E9%A1%8C%E6%9D%90:%E5%90%B8%E8%A1%80%E9%AC%BC&AndOr=OR&start_year=1900&end_year=2024&manga=on&anime=on&novel=on)）
- 毎回検索トップにランダムに作品が表示されるようにした。これによりただ調べるだけでなく新しい作品に出会える機会がふえて楽しくなると思った。
- 「ゆるゆる検索」だからゆるーいキャラクタを配置した。
### in 作品ページ：
- wikipedia情報の表示UIを工夫した。特にWikipediaの本文を階層構造を持つようにdetailsを使って表示を行った。これにより見たいパートにすぐに飛べるようになった（と思う）。
- 作品の著者や舞台・題材・ジャンルなどユーザーが興味ありそうな事項別途再検索できるようにした。
- 登場人物に声優や役者が存在する場合には、その役者でまた再検索できるようにした。
- サムネイルがあったほうが楽しいしわかりやすいと考え、amazonで検索した作品画像が表示されるようにした。
- せっかく検索用に各作品のembeddingベクトルを作成したのだから、、、と思い各作品と(ベクトル的に)類似した作品を表示するようにした。このコサイン類似度の検索はページ読み込み時にリアルタイムに行うようになっているが、行方向約２万、512次元の行列の計算を行うことで低スペックのVPSであっても高速に動作できるように工夫した。
### in サイト作成
- 動的なサイト(htmlから本文を作成し、同時に類似作品を計算し表示する)を作成するにあたってflaskのテンプレートを活用した。
- flask標準のhttpサーバを利用するのはセキュリティ的に脆弱であるため、Nginx+uwsgi+flaskという構成を行った。
- 利用者の声を聞きたかったので、お問い合わせフォームを作成した。フォームに送られた情報は自動的にgmailに転送されるような構成を作成した。
- Google Searchに登録されるようにsitemap.xmlを作成した。
